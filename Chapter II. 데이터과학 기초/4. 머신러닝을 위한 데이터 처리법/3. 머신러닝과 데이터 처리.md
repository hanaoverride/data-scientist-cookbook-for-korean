# 3. 데이터 전처리 전략 가이드: 결측치와 이상치 다루기

## 목차
- [3. 데이터 전처리 전략 가이드: 결측치와 이상치 다루기](#3-데이터-전처리-전략-가이드-결측치와-이상치-다루기)
  - [목차](#목차)
  - [1. 데이터 전처리의 핵심 목표](#1-데이터-전처리의-핵심-목표)
  - [2. 결측치(Missing Values) 처리 전략](#2-결측치missing-values-처리-전략)
    - [상황 1: 결측치가 아주 적을 때 (전체의 5% 미만)](#상황-1-결측치가-아주-적을-때-전체의-5-미만)
    - [상황 2: 결측치가 꽤 많을 때 (5% ~ 50%)](#상황-2-결측치가-꽤-많을-때-5--50)
    - [상황 3: 결측치가 너무 많을 때 (50% 이상)](#상황-3-결측치가-너무-많을-때-50-이상)
  - [3. 이상치(Outliers) 처리 전략](#3-이상치outliers-처리-전략)
    - [1단계: 이상치 탐지 및 원인 파악](#1단계-이상치-탐지-및-원인-파악)
    - [2단계: 처리 전략 수립](#2단계-처리-전략-수립)
  - [4. 실전 코드: 타이타닉 데이터로 결측치/이상치 처리하기](#4-실전-코드-타이타닉-데이터로-결측치이상치-처리하기)

---

## 1. 데이터 전처리의 핵심 목표

1.  **모델의 안정성 확보**: 모델이 오류 없이 학습하고 예측할 수 있도록 데이터의 형식을 맞춰줍니다. (예: 대부분의 모델은 결측치가 있으면 작동하지 않음)
2.  **모델의 성능 향상**: 데이터의 노이즈를 제거하고 패턴을 명확하게 하여, 모델이 데이터로부터 더 잘 학습할 수 있도록 돕습니다.
3.  **편향(Bias) 방지**: 잘못된 데이터 처리로 인해 분석 결과가 왜곡되는 것을 막습니다.

## 2. 결측치(Missing Values) 처리 전략

결측치를 마주했을 때, 가장 먼저 `df.isnull().sum() / len(df) * 100` 코드로 각 변수의 **결측치 비율**을 확인해야 합니다. 비율에 따라 전략이 달라집니다.

### 상황 1: 결측치가 아주 적을 때 (전체의 5% 미만)

- **전략**: **단순 삭제(Deletion)** .
- **이유**: 데이터 손실이 적어 전체 데이터 분포에 미치는 영향이 미미하고, 가장 간단하고 안전한 방법입니다.
- **코드**: `df.dropna(subset=['column_name'])`

### 상황 2: 결측치가 꽤 많을 때 (5% ~ 50%)

- **전략**: **대체(Imputation)** . 삭제하기에는 정보 손실이 너무 큽니다.
- **대체 방법 선택 가이드**:
    - **수치형 데이터**:
        - **평균(Mean)** : 데이터 분포가 대칭적(정규분포 등)일 때 사용.
        - **중앙값(Median)** : **이상치(outlier)가 많을 때** 평균보다 훨씬 안정적인 선택지입니다. (가장 추천)
        - **최빈값(Mode)** : 분포가 특정 값에 몰려있을 때 고려할 수 있습니다.
    - **범주형 데이터**:
        - **최빈값(Mode)** : 가장 자주 나타나는 카테고리로 대체하는 것이 일반적입니다.
        - **'Unknown' 등 별도 카테고리 생성**: 결측이라는 정보 자체가 의미 있을 때 사용합니다.
- **코드**: `df['column'].fillna(df['column'].median())`

### 상황 3: 결측치가 너무 많을 때 (50% 이상)

- **전략**: **해당 변수(열) 삭제(Column Drop)** .
- **이유**: 데이터의 절반 이상이 비어있다면, 어떤 값으로 대체하더라도 심각한 왜곡을 유발할 가능성이 높습니다. 이 변수는 모델에 유용한 정보를 주기 어렵습니다.
- **코드**: `df.drop('column_name', axis=1)`

> **고급 기법**: MICE, KNN Imputer 등 다른 변수와의 관계를 이용해 결측치를 예측하는 모델 기반 대체 방법도 있지만, 계산 비용이 크고 복잡하므로 신중하게 사용해야 합니다.

## 3. 이상치(Outliers) 처리 전략

이상치는 무조건 제거 대상이 아닙니다. 먼저 그 정체를 파악해야 합니다.

### 1단계: 이상치 탐지 및 원인 파악

- **탐지**: `sns.boxplot()`이나 `IQR 규칙`을 사용하여 통계적으로 이상치를 식별합니다.
- **원인 파악**:
    - **측정 오류인가?**: 나이가 -10살, 키가 300cm 처럼 명백한 오류인가?
    - **실제 극단값인가?**: CEO의 연봉, 슈퍼 VIP의 구매액처럼 실제로 발생 가능한 값인가?

### 2단계: 처리 전략 수립

- **Case 1: 명백한 오류일 경우**
    - **전략**: **결측치로 변환 후 처리** 또는 **삭제**.
    - **이유**: 잘못된 정보는 모델 학습에 방해만 됩니다. 결측치로 바꾼 뒤, 위에서 배운 결측치 처리 전략을 적용하는 것이 안전합니다.
    - **코드**: `df.loc[df['age'] < 0, 'age'] = np.nan`

- **Case 2: 실제 극단값일 경우**
    - **전략 1: 그대로 둔다**: 트리 기반 모델(Decision Tree, RandomForest)은 이상치에 비교적 둔감하므로, 그대로 사용해도 괜찮을 수 있습니다.
    - **전략 2: 변환(Transformation)** : 데이터 전체에 로그 변환(`np.log1p`) 등을 적용하여 값의 범위를 줄여주면, 이상치의 영향력을 완화할 수 있습니다.
    - **전략 3: 상/하한 대체(Capping)** : IQR 규칙 등으로 계산된 상한/하한 값을 벗어나는 값들을 모두 상한/하한 값으로 바꿔줍니다.

## 4. 실전 코드: 타이타닉 데이터로 결측치/이상치 처리하기

```python
import pandas as pd
import numpy as np
import seaborn as sns

df = sns.load_dataset('titanic')

# --- 결측치 처리 ---
# 1. age: 결측치 비율이 꽤 있으므로(약 20%), 중앙값으로 대체
age_median = df['age'].median()
df['age'].fillna(age_median, inplace=True)

# 2. embarked, embark_town: 결측치가 매우 적으므로(2건), 최빈값으로 대체
embarked_mode = df['embarked'].mode()[0]
df['embarked'].fillna(embarked_mode, inplace=True)
df['embark_town'].fillna(embarked_mode, inplace=True) # embark_town도 동일하게 처리

# 3. deck: 결측치가 너무 많으므로(약 77%), 열 자체를 삭제
df.drop('deck', axis=1, inplace=True)

print("--- 결측치 처리 후 ---")
print(df.isnull().sum())


# --- 이상치 처리 ---
# fare(요금) 변수의 이상치 확인 및 처리
plt.figure(figsize=(6, 4))
sns.boxplot(x=df['fare'])
plt.title('요금(fare) 분포')
plt.show()

# IQR 기반으로 상한값 계산
Q1 = df['fare'].quantile(0.25)
Q3 = df['fare'].quantile(0.75)
IQR = Q3 - Q1
upper_bound = Q3 + 1.5 * IQR

# 상한값을 초과하는 이상치를 상한값으로 대체 (Capping)
df.loc[df['fare'] > upper_bound, 'fare'] = upper_bound

print(f"\n이상치 처리 후 최대 요금: {df['fare'].max():.2f}")
```

